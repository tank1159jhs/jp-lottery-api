name: Update Loto6 Data

# ë§¤ì£¼ ì›”ìš”ì¼, ëª©ìš”ì¼ 21:30 (JST ì¶”ì²¨ í›„) ìë™ ì‹¤í–‰
on:
  schedule:
    # UTC ì‹œê°„ ê¸°ì¤€: JST 21:30 = UTC 12:30
    - cron: '30 12 * * 1,4'  # ì›”ìš”ì¼, ëª©ìš”ì¼ 12:30 UTC
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  crawl-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ğŸ“¦ Install dependencies
        run: npm install
        
      - name: ğŸ” Crawl Loto6 data
        run: npm run crawl
        continue-on-error: false  # í¬ë¡¤ë§ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨
        
      - name: ğŸ“Š Check data files
        run: |
          echo "=== Data files created ==="
          ls -lh data/loto6/ || echo "No data directory"
          if [ -f data/loto6/latest.json ]; then
            echo "=== Latest data ==="
            cat data/loto6/latest.json
          else
            echo "âŒ latest.json not found - crawl failed!"
            exit 1
          fi
        
      - name: ğŸ“¤ Commit and push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/loto6/
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "âš ï¸  ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ê±´ë„ˆëœ€"
          else
            # latest.jsonì—ì„œ íšŒì°¨ ì •ë³´ ì¶”ì¶œ
            ROUND=$(cat data/loto6/latest.json | grep -o '"round": [0-9]*' | grep -o '[0-9]*')
            git commit -m "ğŸ° Update Loto6 data - ç¬¬${ROUND}å› ($(date +'%Y-%m-%d %H:%M JST'))"
            git push
            echo "âœ… ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
